{% extends "base.html" %}
{% block title %}
{{ config.extra.author }} - {{ section.title }}
{% endblock title %}
{% block content %}

<style>
    /* Add a background color and some padding around the form */
    .contact_container {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding: 20px;
    }

    .formlabel::after {
        content:" *";
        color: red;
    }
</style>


<section class="main style1 ">
    <header class="major" style="text-align: center">
        {{ section.content | safe}}
    </header>
    <div class="container contact_container">
        <form id="contact-form" class="pageclip-form" onSubmit='onDataCallback(); return false;' action="https://send.pageclip.co/xsgAwzGUPZLGLFaGYgXtzqLpxkxflZYh/contact-form"   method="POST">
            <label class="formlabel" for="name">Full Name</label>
                <input required="required" class="required"type="text" id="name" name="Name" placeholder="Firstname Lastname" />

            <label class="formlabel" for="email">Email</label>
                <input required="required" class="required" type="email" id="email" name="Email" placeholder="example@mail.com" />

            <label class="formlabel" for="message">Message</label>
                <textarea required="required" class="required" id="message" name="Message" style="height:200px"></textarea>

            <input id="btnsubmit" type="submit" value="Submit" class="pageclip-form__submit g-recaptcha"
                   data-sitekey="{{ config.extra.recaptcha_sitekey}}"/>
        </form>
        <label for="honeypot" style="display: none">
            <input type="checkbox" id="honeypot"/> Click here to accept the terms of usage of this contact form.
        </label>
    </div>

</section>
<script src="https://www.google.com/recaptcha/api.js?render={{ config.extra.recaptcha_sitekey }}"></script>
<script type="text/javascript">

    async function onDataCallback() {
       const hp = document.querySelector('#honeypot');
       if(!hp.checked){
           grecaptcha.ready(function() {
               grecaptcha.execute('{{ config.extra.recaptcha_sitekey }}', {action: 'submit'}).then(async function(token) {
                   try{
                       await fetch('{{ config.extra.validation_server | safe}}', {
                           method: 'POST',
                           cache: 'no-cache',
                           credentials: 'include',
                           mode:'cors',
                           headers:{
                               'Content-Type':'application/json'
                           },
                           redirect: 'follow',
                           referrerPolicy: 'no-referrer',
                           body: JSON.stringify({ public_key: '{{ config.extra.recaptcha_sitekey }}', ip: await getIP(), response: token })
                       }).then(async (response) => {
                           response = await response.json()
                           if(response['success'] === "True" && response['score'] > 0.7){
                               document.forms.item(0).submit();
                           }/*else if(response.status === 429){
                               alert("You have attempted too many requests. Please try again tomorrow or email me directly. Thank you!");
                           } */else {
                               alert("An error occurred while validating the reCAPTCHA data. Please refresh and try again.");
                               location.reload();
                           }
                       })
                   } catch(err){
                       console.log(err);
                       return false;
                   }
               });
           });
       } else {
           console.log("Bad bot.")
           window.location.href="https://google.com"
       }
       return false;
    }

    // document.addEventListener("DOMContentLoaded", async function(){
    //     console.log(await getIP());
    // })

    async function getIP(){
        try {
            return await fetch('https://ipinfo.io/json?token={{ config.extra.ipinfo_sitekey }}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'default',
            }).then(async (response) => {
                response = await Promise.resolve(response.json());
                return response['ip'];
            });
        } catch (error) {
            console.error(error);
        }
    }

    window.onbeforeunload = function(){
        document.forms.item(0).reset()
    }
</script>
{% endblock content %}


