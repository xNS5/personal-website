{% extends "base.html" %}
{% block title %}
{{ config.extra.author }} - {{ section.title }}
{% endblock title %}
{% block content %}

<style>
    /* Add a background color and some padding around the form */
    .contact_container {
        border-radius: 5px;
        background-color: #f2f2f2;
        padding: 20px;
    }

    .formlabel::after {
        content:" *";
        color: red;
    }
</style>


<section class="main style1 ">
    <header class="major" style="text-align: center">
        {{ section.content | safe}}
        <p>Please be aware that I require your IP address to ensure that you're not a bot.<br>
           If this isn't acceptable, please feel free to shoot me an email at <a href="mailto:michael@michaelkennedy.dev">michael@michaelkennedy.dev</a> to get in touch.
        </p>

    </header>
    <div class="container contact_container">
        <form id="contact-form" class="pageclip-form" onsubmit='return false;' action="https://send.pageclip.co/xsgAwzGUPZLGLFaGYgXtzqLpxkxflZYh/contact-form"  method="POST">
            <label class="formlabel" for="name">Full Name</label>
                <input required="required" class="required" type="text" id="name" name="Name" placeholder="Firstname Lastname" />

            <label class="formlabel" for="email">Email</label>
                <input required="required" class="required" type="email" id="email" name="Email" placeholder="example@mail.com" />

            <label class="formlabel" for="message">Message</label>
                <textarea required="required" class="required" id="message" name="Message" style="height:200px"></textarea>

            <input type="submit" value="Submit" class="g-recaptcha pageclip-form__submit "
                    data-sitekey="{{ config.extra.recaptcha_sitekey}}"
                    data-callback='formCallback'
                    data-action='submit'/>
        </form>
        <label style="display: none !important">
            <input type="checkbox" id="honeypot" value="1" tabindex="-1" autocomplete="off"/> Click here to accept the terms of usage of this contact form.
        </label>
    </div>


</section>
<script src="https://www.google.com/recaptcha/api.js?render={{ config.extra.recaptcha_sitekey }}"></script>
<script type="text/javascript">

    async function formCallback() {
       const hp = document.getElementById("honeypot");
       if(!hp.checked){
           var inputs = document.getElementsByClassName('required');
           var str = ""
           for(var i = 0; i < inputs.length; i++){
               if(inputs[i].value.length === 0){
                   str += (inputs[i].name.charAt(0).toUpperCase() + inputs[i].name.slice(1)+'\n');
               }
           }
           if(str.length > 0){
               alert(`Please fill out the following fields:\n\n${str}`)
           } else {
               grecaptcha.ready(function() {
                   grecaptcha.execute('{{ config.extra.recaptcha_sitekey }}', {action: 'submit'}).then(async function(token) {
                       try{
                           await getIP().then(async (ip) => {
                               if(ip) {
                                   await fetch('{{ config.extra.validation_server | safe}}', {
                                       method: 'POST',
                                       cache: 'no-cache',
                                       credentials: 'include',
                                       mode: 'cors',
                                       headers: {
                                           'Content-Type': 'application/json',
                                           'Access-Control-Allow-Origin': "http://localhost:1111"
                                       },
                                       redirect: 'follow',
                                       referrerPolicy: 'no-referrer',
                                       body: JSON.stringify({
                                           public_key: '{{ config.extra.recaptcha_sitekey }}',
                                           ip: ip,
                                           response: token
                                       })
                                   }).then(async (response) => {
                                       response = await response.json()
                                       if (response['score'] < 0.7) {
                                           alert("An error occurred while validating the reCAPTCHA data. Please refresh and try again.");
                                           location.reload();
                                       } else {
                                           console.log(document.getElementById("g-recaptcha-response").innerText)
                                           document.getElementById("g-recaptcha-response").remove();
                                           document.forms.item(0).submit();
                                       }
                                   })
                               }})
                       } catch(err){
                           alert("An error occurred while submitting the form. Please try again, or just shoot me an email.")
                           console.log(err);
                       }
                   });
               })
           }
       } else {
           console.log("Bad bot.")
           window.location.href="https://google.com"
       }
    }

    async function getIP(){
        try {
            return await fetch('https://ipinfo.io/json?token={{ config.extra.ipinfo_sitekey }}', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'default',
            }).then(async (response) => {
                response = await Promise.resolve(response.json());
                return response['ip'];
            });
        } catch (error) {
            alert("An error has occurred. Please ensure that your adblocker is disabled and try again.")
            console.error(error);
        }
    }

    window.onbeforeunload = function(){
        document.forms.item(0).reset()
    }
</script>
{% endblock content %}


